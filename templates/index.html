{% extends "base.html" %}

{% block content %}

<div class="main-layout">

    <div>
        <div style="background: white; padding: 25px; border-radius: 16px; margin-bottom: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border: 1px solid #e0e6ed;">
            <form action="/recherche" method="GET" style="display: flex; gap: 12px; position: relative;">
                <input type="text" name="q" value="{{ search_term }}" placeholder="ğŸ” Rechercher un produit (ex: ThÃ©, Bazin)..." style="flex: 1;">
                <button type="submit" class="btn-primary" style="width: auto; padding: 14px 32px;">ğŸ” Rechercher</button>
            </form>
            <small style="color: #6c757d; display: block; margin-top: 8px; font-style: italic;">
                ğŸ’¡ <strong>Astuce :</strong> La recherche contient une faille XSS Reflected (pour rappel).
            </small>

            <div style="margin-top: 15px;">
                RÃ©sultats pour : {{ search_term | safe }}
            </div>
        </div>

        <div class="products-grid">
            {% if produits %}
                {% for p in produits %}
                <div class="card" style="position: relative;">

                  <form action="/acheter/{{ p.id }}" method="POST" style="position: absolute; top: 15px; right: 15px; z-index: 10; display: flex; align-items: center; gap: 5px;">
                     <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

                     {% if p.quantite > 0 %}
                         <input type="number" name="qty" value="1" style="width: 50px; font-size: 1rem; border: 1px solid #ccc; border-radius: 4px; padding-left: 5px;">

                         <a href="javascript:void(0);"
                            onclick="this.closest('form').submit();"
                            style="text-decoration: none; font-size: 1.5rem; cursor: pointer;"
                            title="Acheter">
                            ğŸ›’
                         </a>
                     {% else %}
                         <button disabled class="btn btn-secondary btn-sm" style="font-size: 0.7rem;">Rupture</button>
                     {% endif %}
                 </form>

                    <div>
                        <div style="font-size: 3.5rem; text-align: center; margin-bottom: 15px; filter: grayscale(0.2); transition: all 0.3s ease;">
                            ğŸ“¦
                        </div>
                        <h3>{{ p['nom'] }}</h3>
                        <p style="color: #6c757d; font-size: 0.9rem; line-height: 1.5;">
                            {{ p['description'] }}
                        </p>
                    </div>
                    <div>
                        <div class="price">{{ p['prix'] }} MRU</div>
                        <a href="/produit/{{ p['id'] }}" class="btn-buy" style="display: block; text-align: center; text-decoration: none; color: white;">
                            ğŸ‘ï¸ Voir DÃ©tails
                        </a>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div style="grid-column: 1 / -1; text-align: center; padding: 60px 40px; background: white; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border: 2px dashed #e0e6ed;">
                    <div style="font-size: 4rem; margin-bottom: 20px; opacity: 0.3;">ğŸ“­</div>
                    <h3 style="color: var(--primary); font-size: 1.5rem; margin-bottom: 10px;">Aucun produit trouvÃ©</h3>
                    <p style="color: #6c757d;">Essayez une autre recherche ou parcourez notre catalogue complet.</p>
                </div>
            {% endif %}
        </div>
    </div>

    <aside>
        <div class="wallet-card">
            <h3 style="margin-top: 0; color: var(--primary); font-size: 1.4rem; font-weight: 800; display: flex; align-items: center; gap: 10px;">
                <span>ğŸ’°</span>
                <span>Mon Portefeuille</span>
            </h3>

            <div style="font-size: 2.8rem; font-weight: 900; color: var(--primary); text-align: center; padding: 25px; background: linear-gradient(135deg, rgba(0, 107, 60, 0.05) 0%, rgba(255, 215, 0, 0.05) 100%); border-radius: 15px; margin-bottom: 20px; border: 2px dashed var(--gold);">
                {{ session.get('solde_mru', 0) }} <span style="font-size: 1.2rem; color: #6c757d;">MRU</span>
            </div>

            <hr style="border: 0; border-top: 2px solid #e0e6ed; margin: 25px 0;">

            <h4 style="color: var(--text); margin-bottom: 10px; font-size: 1.1rem; font-weight: 700;">
                ğŸ« Code Promo / Recharge
            </h4>

            <div id="promo-display" style="color: #006b3c; font-weight: bold; margin-bottom: 10px; min-height: 5px;"></div>

            <script>
                const params = new URLSearchParams(window.location.search);
                const promo = params.get('promo');

                if (promo) {
                    // âŒ DANGER : innerHTML sans Ã©chappement
                    document.getElementById('promo-display').innerHTML = promo;
                }
            </script>

            <p style="font-size: 0.9rem; color: #6c757d; margin-bottom: 15px;">
                Entrez le code Ã  12 chiffres de votre carte.
            </p>

            <form action="/recharger" method="POST" style="display: flex; flex-direction: column; gap: 15px;">
                <input
                    type="text"
                    name="code_pin"
                    placeholder="Entrez le code Ã  12 chiffres"
                    maxlength="12"
                    pattern="\d{12}"
                    required
                >
                <button type="submit" class="btn-primary" style="background: linear-gradient(135deg, var(--secondary) 0%, #a01518 100%); box-shadow: 0 4px 12px rgba(208, 28, 31, 0.3);">
                    âœ“ Valider le Code
                </button>
            </form>

            <div style="margin-top: 20px; padding: 12px; background: #e7f3ff; border-radius: 8px; border-left: 3px solid #0066cc;">
                <p style="margin: 0; font-size: 0.85rem; color: #004085;">
                    <strong>ğŸ’¡ Info :</strong> Les codes sont disponibles chez nos partenaires.
                </p>
            </div>

            <hr style="border: 0; border-top: 2px solid #e0e6ed; margin: 25px 0;">

            <h4 style="color: var(--text); margin-bottom: 10px; font-size: 1.1rem; font-weight: 700;">
                ğŸ’¸ Envoyer du CrÃ©dit
            </h4>

            <p style="font-size: 0.9rem; color: #6c757d; margin-bottom: 15px;">
                Envoyez des MRU Ã  un ami instantanÃ©ment.
            </p>

            <form action="/transfert" method="POST" style="display: flex; flex-direction: column; gap: 15px;">
                <input
                    type="text"
                    name="destinataire"
                    placeholder="Nom d'utilisateur (ex: sidi_med)"
                    required
                >
                <input
                    type="number"
                    name="montant"
                    placeholder="Montant (MRU)"
                    min="1"
                    required
                >
                <button type="submit" class="btn-primary" style="background: var(--primary);">
                    â¡ï¸ Envoyer
                </button>
            </form>
        </div> </aside>

</div>
{% endblock %}