{% extends 'base.html' %}

{% block content %}
<div style="max-width: 1400px; margin: 0 auto;">

    <!-- En-t√™te avec bouton Ajouter -->
    <div style="background: var(--white); padding: 25px; border-radius: 16px; margin-bottom: 25px; box-shadow: 0 4px 12px var(--shadow); display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h2 style="margin: 0; color: var(--primary); font-size: 2rem; font-weight: 800;">
                üë• Gestion des Utilisateurs
            </h2>
            <p style="margin: 5px 0 0 0; color: #6c757d;">Administration de la plateforme El Baraka</p>
        </div>
        <button onclick="openModal('add')" class="btn-primary" style="width: auto; padding: 14px 32px;">
            ‚ûï Nouvel Utilisateur
        </button>
    </div>

    <!-- Tableau des utilisateurs -->
    <div style="background: var(--white); padding: 25px; border-radius: 16px; box-shadow: 0 4px 12px var(--shadow); overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white;">
                    <th style="padding: 15px; text-align: left; font-weight: 700;">ID</th>
                    <th style="padding: 15px; text-align: left; font-weight: 700;">Nom d'utilisateur</th>
                    <th style="padding: 15px; text-align: left; font-weight: 700;">T√©l√©phone</th>
                    <th style="padding: 15px; text-align: left; font-weight: 700;">Adresse</th>
                    <th style="padding: 15px; text-align: left; font-weight: 700;">Solde (MRU)</th>
                    <th style="padding: 15px; text-align: center; font-weight: 700;">Admin</th>
                    <th style="padding: 15px; text-align: center; font-weight: 700;">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr style="border-bottom: 1px solid var(--border); transition: background 0.3s ease;"
                    onmouseover="this.style.background='#f8f9fa'"
                    onmouseout="this.style.background='white'">
                    <td style="padding: 15px; font-weight: 600;">{{ user.id }}</td>
                    <td style="padding: 15px;">
                        <strong style="color: var(--primary);">{{ user.username }}</strong>
                    </td>
                    <td style="padding: 15px; color: #6c757d;">{{ user.telephone or '‚Äî' }}</td>
                    <td style="padding: 15px; color: #6c757d;">{{ user.adresse or '‚Äî' }}</td>
                    <td style="padding: 15px; font-weight: 700; color: var(--primary);">
                        {{ "%.2f"|format(user.solde_mru) }} MRU
                    </td>
                    <td style="padding: 15px; text-align: center;">
                        {% if user.est_admin %}
                            <span style="background: var(--gold); color: #856404; padding: 5px 12px; border-radius: 20px; font-weight: 600; font-size: 0.85rem;">
                                üëë Admin
                            </span>
                        {% else %}
                            <span style="background: #e9ecef; color: #6c757d; padding: 5px 12px; border-radius: 20px; font-weight: 600; font-size: 0.85rem;">
                                üë§ User
                            </span>
                        {% endif %}
                    </td>
                    <td style="padding: 15px; text-align: center;">
                        <button onclick="openModal('edit', {{ user.id }}, '{{ user.username }}', '{{ user.telephone }}', '{{ user.adresse }}', {{ user.solde_mru }}, {{ user.est_admin|int }})"
                                style="background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; margin-right: 5px; font-weight: 600; transition: all 0.3s ease;"
                                onmouseover="this.style.background='#0056b3'"
                                onmouseout="this.style.background='#007bff'">
                            ‚úèÔ∏è Modifier
                        </button>
                        <button onclick="deleteUser({{ user.id }}, '{{ user.username }}')"
                                style="background: var(--secondary); color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease;"
                                onmouseover="this.style.background='#a01518'"
                                onmouseout="this.style.background='var(--secondary)'">
                            üóëÔ∏è Supprimer
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        {% if users|length == 0 %}
        <div style="text-align: center; padding: 60px 20px; color: #6c757d;">
            <div style="font-size: 4rem; margin-bottom: 15px;">üë•</div>
            <h3 style="color: var(--primary); margin-bottom: 10px;">Aucun utilisateur</h3>
            <p>Commencez par ajouter un nouvel utilisateur</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Modal Ajouter/Modifier Utilisateur -->
<div id="userModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; backdrop-filter: blur(5px);">
    <div style="background: white; max-width: 380px; margin: 20px auto; border-radius: 10px; box-shadow: 0 8px 30px rgba(0,0,0,0.3); animation: slideDown 0.3s ease;">
        <div style="background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; padding: 12px 15px; border-radius: 10px 10px 0 0; display: flex; justify-content: space-between; align-items: center;">
            <h3 id="modalTitle" style="margin: 0; font-size: 1.05rem; font-weight: 800;">‚ûï Nouvel Utilisateur</h3>
            <button onclick="closeModal()" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; font-size: 1.1rem; font-weight: bold; transition: all 0.3s ease;"
                    onmouseover="this.style.background='rgba(255,255,255,0.3)'"
                    onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                ‚úï
            </button>
        </div>

        <form id="userForm" method="POST" style="padding: 15px;">
            <input type="hidden" id="userId" name="user_id">

            <div class="form-group" style="margin-bottom: 10px;">
                <label style="font-size: 0.8rem; margin-bottom: 4px; display: block; font-weight: 600;">üë§ Username *</label>
                <input type="text" id="username" name="username" required
                       style="width: 100%; padding: 8px 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 0.85rem; transition: all 0.3s ease;">
            </div>

            <div class="form-group" style="margin-bottom: 10px;" id="passwordGroup">
                <label style="font-size: 0.8rem; margin-bottom: 4px; display: block; font-weight: 600;">üîí Password *</label>
                <input type="password" id="password" name="password"
                       style="width: 100%; padding: 8px 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 0.85rem; transition: all 0.3s ease;">
                <small style="color: #6c757d; font-size: 0.7rem; display: block; margin-top: 2px;">
                    <em id="passwordHint">Min. 6 caract√®res</em>
                </small>
            </div>

            <div class="form-group" style="margin-bottom: 10px;">
                <label style="font-size: 0.8rem; margin-bottom: 4px; display: block; font-weight: 600;">üì± T√©l√©phone</label>
                <input type="text" id="telephone" name="telephone" placeholder="+222 XX XX XX XX"
                       style="width: 100%; padding: 8px 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 0.85rem; transition: all 0.3s ease;">
            </div>

            <div class="form-group" style="margin-bottom: 10px;">
                <label style="font-size: 0.8rem; margin-bottom: 4px; display: block; font-weight: 600;">üìç Adresse</label>
                <textarea id="adresse" name="adresse" rows="2" placeholder="Adresse..."
                          style="width: 100%; padding: 8px 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 0.85rem; transition: all 0.3s ease; resize: vertical; font-family: inherit;"></textarea>
            </div>

            <div class="form-group" style="margin-bottom: 10px;">
                <label style="font-size: 0.8rem; margin-bottom: 4px; display: block; font-weight: 600;">üí∞ Solde</label>
                <input type="number" id="solde_mru" name="solde_mru" step="0.01" value="0.00" min="0"
                       style="width: 100%; padding: 8px 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 0.85rem; transition: all 0.3s ease;">
            </div>

            <div class="form-group" style="margin-bottom: 10px;">
                <label style="display: flex; align-items: center; cursor: pointer; user-select: none;">
                    <input type="checkbox" id="est_admin" name="est_admin" value="1"
                           style="width: 14px; height: 14px; margin-right: 6px; cursor: pointer;">
                    <span style="font-weight: 600; font-size: 0.8rem;">üëë Admin</span>
                </label>
            </div>

            <div style="display: flex; gap: 8px; margin-top: 12px;">
                <button type="button" onclick="closeModal()"
                        style="flex: 1; padding: 8px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.85rem; transition: all 0.3s ease;"
                        onmouseover="this.style.background='#5a6268'"
                        onmouseout="this.style.background='#6c757d'">
                    Annuler
                </button>
                <button type="submit"
                        style="flex: 2; padding: 8px; background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 700; font-size: 0.85rem; transition: all 0.3s ease; box-shadow: 0 3px 10px rgba(0, 107, 60, 0.3);"
                        onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(0, 107, 60, 0.4)'"
                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(0, 107, 60, 0.3)'">
                    üíæ Enregistrer
                </button>
            </div>
        </form>
    </div>
</div>

<style>
@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-50px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Style focus pour tous les inputs du modal */
#userModal input:focus,
#userModal textarea:focus {
    outline: none !important;
    border-color: var(--primary) !important;
    box-shadow: 0 0 0 3px rgba(0, 107, 60, 0.1) !important;
}

/* Responsive pour le tableau */
@media (max-width: 768px) {
    table {
        font-size: 0.9rem;
    }

    th, td {
        padding: 10px !important;
    }

    button {
        padding: 6px 12px !important;
        font-size: 0.85rem !important;
    }
}
</style>

<script>
function openModal(mode, id='', username='', telephone='', adresse='', solde=0.00, est_admin=0) {
    const modal = document.getElementById('userModal');
    const form = document.getElementById('userForm');
    const modalTitle = document.getElementById('modalTitle');
    const passwordInput = document.getElementById('password');
    const passwordHint = document.getElementById('passwordHint');

    // Reset form
    form.reset();

    if (mode === 'add') {
        modalTitle.textContent = '‚ûï Nouvel Utilisateur';
        form.action = '/admin/users/add';
        passwordInput.required = true;
        passwordHint.textContent = 'Minimum 6 caract√®res';
    } else {
        modalTitle.textContent = '‚úèÔ∏è Modifier l\'utilisateur';
        form.action = '/admin/users/edit';
        passwordInput.required = false;
        passwordHint.textContent = 'Laisser vide pour conserver l\'ancien mot de passe';

        // Remplir les champs
        document.getElementById('userId').value = id;
        document.getElementById('username').value = username;
        document.getElementById('telephone').value = telephone || '';
        document.getElementById('adresse').value = adresse || '';
        document.getElementById('solde_mru').value = parseFloat(solde).toFixed(2);
        document.getElementById('est_admin').checked = est_admin === 1;
    }

    modal.style.display = 'block';
}

function closeModal() {
    document.getElementById('userModal').style.display = 'none';
}

function deleteUser(id, username) {
    if (confirm(`‚ö†Ô∏è √ätes-vous s√ªr de vouloir supprimer l'utilisateur "${username}" ?\n\nCette action est irr√©versible !`)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/admin/users/delete';

        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'user_id';
        input.value = id;

        form.appendChild(input);
        document.body.appendChild(form);
        form.submit();
    }
}

// Fermer le modal en cliquant en dehors
window.onclick = function(event) {
    const modal = document.getElementById('userModal');
    if (event.target === modal) {
        closeModal();
    }
}

// Fermer avec la touche Escape
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeModal();
    }
});
</script>

{% endblock %}